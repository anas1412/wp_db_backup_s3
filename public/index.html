<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WordPress Database Backup</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js CDN -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
  </head>
  <body class="bg-gray-100 p-8" x-data="dashboard">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-3xl font-bold mb-6">WordPress Database Backup</h1>

      <!-- Environment Status -->
      <div id="env-status" class="mb-6">
        <template x-if="envStatus.success">
          <p class="text-green-600 font-bold" x-text="envStatus.message"></p>
        </template>
        <template x-if="!envStatus.success">
          <p class="text-red-600 font-bold" x-text="envStatus.message"></p>
        </template>
      </div>

      <!-- Backup and Restore Buttons -->
      <div class="bg-white p-6 rounded-lg shadow mb-6">
        <h2 class="text-xl font-semibold mb-4">Backup and Restore</h2>
        <div class="space-x-4">
          <button
            @click="startBackup"
            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
          >
            Start Backup
          </button>
          <button
            @click="restoreDatabase"
            class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"
          >
            Restore Database
          </button>
        </div>
      </div>

      <!-- List of Backups -->
      <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-semibold mb-4">Backups</h2>
        <div x-show="backups.length > 0">
          <table class="w-full">
            <thead>
              <tr class="bg-gray-200">
                <th class="px-4 py-2">Key</th>
                <th class="px-4 py-2">Size</th>
                <th class="px-4 py-2">Last Modified</th>
                <th class="px-4 py-2">Actions</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="backup in backups" :key="backup.key">
                <tr class="border-b">
                  <td class="px-4 py-2" x-text="backup.key"></td>
                  <td class="px-4 py-2" x-text="backup.size"></td>
                  <td class="px-4 py-2" x-text="backup.lastModified"></td>
                  <td class="px-4 py-2">
                    <button
                      @click="deleteBackup(backup.key)"
                      class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600"
                    >
                      Delete
                    </button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        <p x-show="backups.length === 0" class="text-gray-600">
          No backups found.
        </p>
      </div>
    </div>

    <script>
      document.addEventListener("alpine:init", () => {
        Alpine.data("dashboard", () => ({
          envStatus: { success: false, message: "Loading..." },
          backups: [],

          init() {
            this.checkEnvVars();
            this.fetchBackups();
          },

          // Check environment variables
          async checkEnvVars() {
            try {
              const response = await fetch("/env-check");
              const data = await response.json();
              this.envStatus = data;
            } catch (error) {
              this.envStatus = {
                success: false,
                message: "Failed to check environment variables",
              };
            }
          },

          // Fetch list of backups
          async fetchBackups() {
            try {
              const response = await fetch("/backups");
              const data = await response.json();
              this.backups = data.map((backup) => ({
                ...backup,
                lastModified: new Date(backup.lastModified).toLocaleString(),
              }));
            } catch (error) {
              console.error("Failed to fetch backups:", error);
            }
          },

          // Start backup
          async startBackup() {
            try {
              const response = await fetch("/backup", { method: "POST" });
              const data = await response.json();
              alert(data.message);
              this.fetchBackups(); // Refresh the backups list
            } catch (error) {
              alert("Backup failed: " + error.message);
            }
          },

          // Restore database
          async restoreDatabase() {
            const backupKey = prompt("Enter the backup key to restore:");
            if (backupKey) {
              try {
                const response = await fetch(`/restore/${backupKey}`, {
                  method: "POST",
                });
                const data = await response.json();
                alert(data.message);
              } catch (error) {
                alert("Restore failed: " + error.message);
              }
            }
          },

          // Delete backup
          async deleteBackup(key) {
            if (confirm("Are you sure you want to delete this backup?")) {
              try {
                const response = await fetch(`/backups/${key}`, {
                  method: "DELETE",
                });
                const data = await response.json();
                alert(data.message);
                this.fetchBackups(); // Refresh the backups list
              } catch (error) {
                alert("Failed to delete backup: " + error.message);
              }
            }
          },
        }));
      });
    </script>
  </body>
</html>
